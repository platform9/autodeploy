---
- hosts:
    - hypervisors
    - containervisors
  become: true
  gather_facts: False
  pre_tasks:
    - name: get os distribution
      raw: if [ -e /etc/lsb-release ]; then echo "ubuntu"; elif [ -e /etc/centos-release ]; then echo "centos"; fi
      register: os_distr
    - name: install python2
      raw: if [ -e /etc/lsb-release -a ! -e /usr/bin/python ]; then (apt -y update && apt install -y python-minimal); fi
<<<<<<< HEAD
    - debug: msg="Detected OS Distr = {{os_distr.stdout.strip()}}"
=======
>>>>>>> b2160bdb94891218dd6799b3824cee095c2886a5

- hosts: hypervisors
  become: true
  vars_files:
    - pf9-role-metadata.yml
  roles:
    - common
    - ntp
    - qemu-kvm-ev
    - pf9-auth
    - pf9-hostagent
    - neutron-prerequisites
<<<<<<< HEAD
    - { role: "secure-live-migration", when: os_distr.stdout.strip() == "centos" }
=======
    - secure-live-migration
>>>>>>> b2160bdb94891218dd6799b3824cee095c2886a5
    - { role: "map-role", rolename: "pf9-ostackhost-neutron", when: autoreg == "on" }
    - { role: "map-role", rolename: "pf9-neutron-base", when: autoreg == "on" }
    - { role: "map-role", rolename: "pf9-glance-role", when: autoreg == "on" and glance == "on" }
    - { role: "map-role", rolename: "pf9-celiometer-role", when: autoreg == "on" and ceilometer == "on" }
    - { role: "map-role", rolename: "pf9-neutron-ovs-agent", when: autoreg == "on" }
    - { role: "map-role", rolename: "pf9-neutron-l3-agent", when: autoreg == "on" }
    - { role: "map-role", rolename: "pf9-neutron-metadata-agent", when: autoreg == "on" }
    - { role: "map-role", rolename: "pf9-neutron-dhcp-agent", when: autoreg == "on" and dhcp == "on" }
    - { role: "glance-host", when: autoreg == "on" and glance == "on" }

- hosts: containervisors
  become: true
  roles:
    - common
    - ntp
    - pf9-auth
    - pf9-hostagent
    - { role: "map-role", rolename: "pf9-kube", when: autoreg == "on" }
